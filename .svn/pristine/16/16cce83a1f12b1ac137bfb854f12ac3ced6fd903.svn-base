<?php if ( ! defined('BASEPATH')) exit('No direct script access allowed');

/**
 * Chart Class
 *
 * @package		LookingGlassSAE
 * @subpackage	Controllers
 * @category	Controller
 * @author		WDLTH
 * @link		http://www.wdlth.com/
 */

class Chart extends CI_Controller {

	function __construct() {
		parent::__construct();
	}
	
	public function index()
	{
		exit('403 Forbidden.');
	}
	
	public function data()
	{
		$timelinearr = array();
		$n = 1;
		if(intval(date("i")) > 35 || intval(date("i")) <=15 )
		{
			while($n <=12)
			{
				$timelinearr[$n] = date("H", strtotime("-" . 30 * $n . " minutes")) . ":30";
				$timelinearr[$n+1] = date("H", strtotime("-" . 30 * $n . " minutes")) . ":00";
				$n = $n + 2;
			}
		}else{
			while($n <=12)
			{
				$timelinearr[$n] = date("H", strtotime("-" . 30 * $n . " minutes")) . ":00";
				$timelinearr[$n+1] = date("H", strtotime("-" . 30 * $n . " minutes")) . ":30";
				$n = $n + 2;
			}
		}
		$timelinearr = array_reverse($timelinearr);
		
		$xml = new SimpleXMLElement('<chart/>');
		$categories = $xml->addChild('categories');
		for($j = 0; $j < count($timelinearr); $j++)
		{
			$categories -> addChild('item', $timelinearr[$j]);
		}
		
		$this->load->library('Dblib');
		$sourcearr = $this->dblib->getChartSource();
		foreach ($sourcearr as $source)
		{
			$series = $xml->addChild('series');
			$series->addChild('name', $source["source"]);
			$data = $series->addChild('data');
			$pointarr = $this->dblib->getChartPoint($source["source"], 'ChinaTelecom');
			for ($l = 0; $l < 12; $l++)
			{
				$data->addChild('point', intval($pointarr[$l]["avg"]));
			}
				
		}
		header('Content-type: text/xml');
		$dom = new DOMDocument();
		$dom -> loadXML($xml);
		$dom -> formatOutput = TRUE;
		$formattedXML = $dom -> saveXML();
		echo $formattedXML;
		
	}
	
	public function point()
	{
		$this->load->library('Dblib');
		$sourcearr = $this->dblib->getChartSource();
		$xml = new SimpleXMLElement('<chart/>');
		foreach ($sourcearr as $source)
		{
			$series = $xml->addChild('series');
			$series->addChild('name', $source["source"]);
			$data = $series->addChild('data');
			$pointarr = $this->dblib->getChartPoint($source["source"], 'ChinaTelecom');
			for ($l = 0; $l < 12; $l++)
			{
				$data->addChild('point', intval($pointarr[$l]["avg"]));				
			}
			
		}
		header('Content-type: text/xml');
		echo $xml->asXML();
		
	}
	
	public function timeline()
	{
		$timelinearr = array();
		$n = 1;
		if(intval(date("i")) > 35 || intval(date("i")) <=15 )
		{
			while($n <=12)
			{
				$timelinearr[$n] = date("H", strtotime("-" . 30 * $n . " minutes")) . ":30";
				$timelinearr[$n+1] = date("H", strtotime("-" . 30 * $n . " minutes")) . ":00";
				$n = $n + 2;
			}
		}else{
			while($n <=12)
			{
				$timelinearr[$n] = date("H", strtotime("-" . 30 * $n . " minutes")) . ":00";
				$timelinearr[$n+1] = date("H", strtotime("-" . 30 * $n . " minutes")) . ":30";
				$n = $n + 2;
			}
		}
		$timelinearr = array_reverse($timelinearr);
		
		$xml = new SimpleXMLElement('<chart/>');
		$categories = $xml->addChild('categories');
		for($j = 0; $j < count($timelinearr); $j++)
		{
			$categories -> addChild('item', $timelinearr[$j]);
		}
		header('Content-type: text/xml');
		echo $xml->asXML();
	}

}