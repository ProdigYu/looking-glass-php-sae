<?php  if (!defined('BASEPATH')) exit('No direct script access allowed');

/**
 * Dblib Class
 *
 * @package		LookingGlassSAE
 * @subpackage	Libraries
 * @category	Library
 * @author		WDLTH
 * @link		http://www.wdlth.com/
 */

class Dblib {
	
	public function getChartSource()
	{
		$mysql = new SaeMysql();
	
		$sql = "SELECT `source` FROM `ping` GROUP BY `source`";
	
		$resultArray = $mysql -> getData($sql);
	
		if( $mysql->errno() != 0 )
		{
			log_message('error', "MySQL Error: " . $mysql->errmsg());
			//die( "Error: " . $mysql->errmsg() );
			die($sql);
		}
	
		$mysql->closeDb();
		
		$config = array (
				'root'    => 'root',
				'element' => 'element',
				'newline' => "\n",
				'tab'     => "\t"
		);
		$this->load->dbutil();
		$xml = $this->dbutil->xml_from_result(array_reverse($timelinearr), $config);
	
		return $xml;
	}
	
	public function getHomepageChart($destination)
	{
		$mysql = new SaeMysql();
	
		$sql = "SELECT * FROM (SELECT `source`,`avg`,`time` FROM `ping` WHERE `destination`='" . $mysql->escape($destination) . "' ORDER BY `time` DESC LIMIT 0,60) AS P GROUP BY `source` ORDER BY `time` DESC";
	
		$resultArray = $mysql -> getData($sql);
	
		if( $mysql->errno() != 0 )
		{
			log_message('error', "MySQL Error: " . $mysql->errmsg());
			//die( "Error: " . $mysql->errmsg() );
			die($sql);
		}
	
		$mysql->closeDb();
	
		return $resultArray;
	}
	
	public function gethomepageping($destination)
	{
		$mysql = new SaeMysql();
		
		$sql = "SELECT * FROM (SELECT * FROM `ping` WHERE `destination`='" . $mysql->escape($destination) . "' ORDER BY `time` DESC LIMIT 0,60) AS P GROUP BY `source` ORDER BY `time` DESC";
		
		$resultArray = $mysql -> getData($sql);
		
		if( $mysql->errno() != 0 )
		{
			log_message('error', "MySQL Error: " . $mysql->errmsg());
			//die( "Error: " . $mysql->errmsg() );
			die($sql);
		}
		
		$mysql->closeDb();
		
		return $resultArray;
	}
	
	public function saveping($source, $destination, $min, $avg, $max, $loss)
	{
		$mysql = new SaeMysql();
		
		$sql = "INSERT INTO `ping` (`source`, `destination`, `min`, `avg`, `max`, `loss`, `time`)" .
				" VALUES ('" . $mysql->escape($source) . "', '" . $mysql->escape($destination) ."', " .
				$min . ", " . $avg . ", " . $max . ", " . $loss . ", NOW())";
		
		$mysql -> runSql($sql);
		if( $mysql->errno() != 0 )
		{
			log_message('error', "MySQL Error: " . $mysql->errmsg());
			//die( "Error: " . $mysql->errmsg() );
			die($sql);
		}
		
		$mysql->closeDb();
	}
	
}
