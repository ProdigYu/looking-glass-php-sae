<?php  if (!defined('BASEPATH')) exit('No direct script access allowed');

/**
 * Dblib Class
 *
 * @package		LookingGlassSAE
 * @subpackage	Libraries
 * @category	Library
 * @author		WDLTH
 * @link		http://www.wdlth.com/
 */

class Dblib {
	
	public function getChartPoint($source, $destination)
	{
		$mysql = new SaeMysql();
	
		$sql = "SELECT * FROM `ping` WHERE `source`='" . $mysql->escape($source) . "' AND `destination`='" . $mysql->escape($destination) . "' ORDER BY `time` DESC LIMIT 0,12";
	
		$resultArray = $mysql -> getData($sql);
	
		if( $mysql->errno() != 0 )
		{
			log_message('error', "MySQL Error: " . $mysql->errmsg());
			//die( "Error: " . $mysql->errmsg() );
			die($sql);
		}
	
		$mysql->closeDb();
	
		return $resultArray;
	}
	
	public function getChartDestination()
	{
		$mysql = new SaeMysql();
	
		$sql = "SELECT `destination` FROM `ping` GROUP BY `destination`";
	
		$resultArray = $mysql -> getData($sql);
	
		if( $mysql->errno() != 0 )
		{
			log_message('error', "MySQL Error: " . $mysql->errmsg());
			//die( "Error: " . $mysql->errmsg() );
			die($sql);
		}
	
		$mysql->closeDb();
	
		return $resultArray;
	}
	
	public function getChartSource()
	{
		$CI =& get_instance();
		$CI->load->driver('cache');
		
		$resultArray = array();
		
		if($CI->cache->memcached->get('ChartSource') == "")
		{
			$mysql = new SaeMysql();
			
			$sql = "SELECT `source` FROM `ping` GROUP BY `source`";
			
			$resultArray = $mysql -> getData($sql);
			
			if( $mysql->errno() != 0 )
			{
				log_message('error', "MySQL Error: " . $mysql->errmsg());
				//die( "Error: " . $mysql->errmsg() );
				die($sql);
			}
			
			$CI->cache->memcached->save('ChartSource', $resultArray, 1500);
			log_message('notice', "Saved \"ChartSource\" to memcached");
			$mysql->closeDb();
		}else{
			$CI->cache->memcached->get('ChartSource');
			log_message('notice', "Loaded \"ChartSource\" from memcached");
		}
		
		return $resultArray;
	}
	
	public function getHomepageChart($destination)
	{
		$mysql = new SaeMysql();
	
		$sql = "SELECT * FROM (SELECT `source`,`avg`,`time` FROM `ping` WHERE `destination`='" . $mysql->escape($destination) . "' ORDER BY `time` DESC LIMIT 0,60) AS P GROUP BY `source` ORDER BY `time` DESC";
	
		$resultArray = $mysql -> getData($sql);
	
		if( $mysql->errno() != 0 )
		{
			log_message('error', "MySQL Error: " . $mysql->errmsg());
			//die( "Error: " . $mysql->errmsg() );
			die($sql);
		}
	
		$mysql->closeDb();
	
		return $resultArray;
	}
	
	public function gethomepageping($destination)
	{
		$mysql = new SaeMysql();
		
		$sql = "SELECT * FROM (SELECT * FROM `ping` WHERE `destination`='" . $mysql->escape($destination) . "' ORDER BY `time` DESC LIMIT 0,60) AS P GROUP BY `source` ORDER BY `time` DESC";
		
		$resultArray = $mysql -> getData($sql);
		
		if( $mysql->errno() != 0 )
		{
			log_message('error', "MySQL Error: " . $mysql->errmsg());
			//die( "Error: " . $mysql->errmsg() );
			die($sql);
		}
		
		$mysql->closeDb();
		
		return $resultArray;
	}
	
	public function saveping($source, $destination, $min, $avg, $max, $loss)
	{
		$mysql = new SaeMysql();
		
		$sql = "INSERT INTO `ping` (`source`, `destination`, `min`, `avg`, `max`, `loss`, `time`)" .
				" VALUES ('" . $mysql->escape($source) . "', '" . $mysql->escape($destination) ."', " .
				$min . ", " . $avg . ", " . $max . ", " . $loss . ", NOW())";
		
		$mysql -> runSql($sql);
		if( $mysql->errno() != 0 )
		{
			log_message('error', "MySQL Error: " . $mysql->errmsg());
			//die( "Error: " . $mysql->errmsg() );
			die($sql);
		}
		
		$mysql->closeDb();
	}
	
}
